<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin · Epoka Electronics</title>
  <link rel="stylesheet" href="/css/styles.css" />
</head>
<body>
  <div class="topbar">
    <div class="container">
      <div class="nav">
        <a class="brand" href="/">
          <img class="logo" src="/assets/logo/Epoka Electronics.png" alt="">
          <div>Epoka Electronics</div>
        </a>
        <div class="nav-actions">
          <a class="btn secondary" href="/">Shop</a>
          <a class="btn secondary" href="/cart.html">Cart <span class="badge" data-cartcount>0</span></a>
          <div data-account></div>
        </div>
      </div>
    </div>
  </div>

  <div class="container" style="padding:18px 0 34px">
    <div class="card" style="padding:18px">
      <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center">
        <h2 style="margin:0">Admin dashboard</h2>
        <div class="badge">Catalog & Orders</div>
      </div>

      <div id="guard" class="notice" style="margin-top:12px; display:none">Admin access required.</div>

      <div class="two">
        <div class="card" style="padding:16px">
          <h3 style="margin:0 0 10px">Categories</h3>
          <div class="row">
            <input class="textbox" id="catName" placeholder="New category name" />
            <button class="btn" id="addCat">Add</button>
          </div>
          <div id="cats" style="margin-top:12px"></div>
        </div>

        <div class="card" style="padding:16px">
          <h3 style="margin:0 0 10px">Products</h3>

          <div class="row">
            <input class="textbox" id="sku" placeholder="SKU (Kodi vecante i produktit)" />
            <input class="textbox" id="pname" placeholder="Name" />
          </div>
          <div class="row">
            <input class="textbox" id="brand" placeholder="Brand" />
            <input class="textbox" id="imageUrl" placeholder="Image URL (optional)" />
          </div>
          <div class="row">
            <input class="textbox" id="price" placeholder="Price" type="number" step="0.01" />
            <input class="textbox" id="stock" placeholder="Stock" type="number" />
          </div>
          <div class="row">
            <select class="select" id="catSelect"></select>
            <select class="select" id="featured">
              <option value="false">Not featured</option>
              <option value="true">Featured</option>
            </select>
          </div>
          <div class="label">Description</div>
          <textarea class="textbox" id="desc" placeholder="Per te publikuar nje produkt sigurouni qe keni ploetesuar cdo gje qe nevojitet" style="min-height:110px"></textarea>

          <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap">
            <button class="btn" id="createProduct">Create product</button>
            <input class="textbox" id="editId" placeholder="Product ID to edit or delete" type="number" style="max-width:180px" />
            <button class="btn secondary" id="loadProduct">Load</button>
            <button class="btn secondary" id="updateProduct">Update</button>
            <button class="btn danger" id="deleteProduct">Delete</button>
          </div>

          <div id="pmsg" class="notice" style="margin-top:12px">Perdor ID e produkit qe shfaqet ne URL per te edituar ose fshirë</div>
        </div>
      </div>

      <div class="card" style="padding:16px; margin-top:14px">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap">
          <h3 style="margin:0">Orders</h3>
          <button class="btn secondary" id="refreshOrders">Refresh</button>
        </div>
        <div id="orders" style="margin-top:12px"></div>
      </div>
    </div>
  </div>

  <div class="toast"></div>
  <script src="/js/app.js"></script>
  <script>
    function ensureAdmin() {
      const sess = Api.session();
      const ok = sess && sess.isAdmin;
      document.getElementById("guard").style.display = ok ? "none" : "block";
      return ok;
    }

    function catRow(c) {
      return `
        <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border:1px solid rgba(255,255,255,.08); border-radius:16px; background:rgba(2,6,23,.35); margin-bottom:10px">
          <div style="font-weight:800">${Ui.escapeHtml(c.name)}</div>
          <button class="btn danger" data-delcat="${c.id}">Delete</button>
        </div>
      `;
    }

    async function loadCategories() {
      const cats = await Api.getCategories();
      document.getElementById("cats").innerHTML = cats.map(catRow).join("");
      document.querySelectorAll("[data-delcat]").forEach(b => {
        b.onclick = async () => {
          try { await Api.adminDeleteCategory(parseInt(b.getAttribute("data-delcat"))); Ui.toast("Deleted", "Category removed."); await loadCategories(); await fillCategorySelect(); }
          catch (e) { Ui.toast("Error", e.message); }
        };
      });
      return cats;
    }

    async function fillCategorySelect() {
      const cats = await Api.getCategories();
      const sel = document.getElementById("catSelect");
      sel.innerHTML = cats.map(c => `<option value="${c.id}">${Ui.escapeHtml(c.name)}</option>`).join("");
    }

    function productPayload() {
      return {
        sku: document.getElementById("sku").value.trim(),
        name: document.getElementById("pname").value.trim(),
        brand: document.getElementById("brand").value.trim() || null,
        price: parseFloat(document.getElementById("price").value || "0"),
        stock: parseInt(document.getElementById("stock").value || "0"),
        imageUrl: document.getElementById("imageUrl").value.trim() || null,
        description: document.getElementById("desc").value.trim() || null,
        categoryId: parseInt(document.getElementById("catSelect").value || "0"),
        isFeatured: document.getElementById("featured").value === "true"
      };
    }

    async function loadOrders() {
      const el = document.getElementById("orders");
      el.innerHTML = `<div class="notice">Loading...</div>`;
      try {
        const orders = await Api.adminAllOrders();
        if (!orders.length) { el.innerHTML = `<div class="notice">No orders yet.</div>`; return; }
        el.innerHTML = orders.map(o => `
          <div class="card" style="padding:14px; margin-bottom:12px">
            <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center">
              <div>
                <div style="font-weight:900">Order #${o.id}</div>
                <div class="muted" style="font-size:12px">${new Date(o.createdAtUtc).toLocaleString()}</div>
              </div>
              <div style="display:flex; gap:10px; align-items:center">
                <span class="badge">${Ui.escapeHtml(o.status)}</span>
                <select class="select" data-status="${o.id}">
                  ${["Pending","Processing","Shipped","Completed","Cancelled"].map(s => `<option value="${s}" ${s===o.status?"selected":""}>${s}</option>`).join("")}
                </select>
                <button class="btn secondary" data-savestatus="${o.id}">Save</button>
              </div>
            </div>
            <div class="muted" style="margin-top:10px">${Ui.escapeHtml(o.shippingName)} · ${Ui.escapeHtml(o.shippingPhone)} · ${Ui.escapeHtml(o.shippingCity)}, ${Ui.escapeHtml(o.shippingCountry)}</div>
            <div style="margin-top:10px">
              ${o.items.map(i => `
                <div style="display:flex; justify-content:space-between; gap:10px; padding:8px 0; border-bottom:1px solid rgba(255,255,255,.06)">
                  <div>
                    <div style="font-weight:800">${Ui.escapeHtml(i.productName)}</div>
                    <div class="muted" style="font-size:12px">${Ui.escapeHtml(i.productSku)} · Qty ${i.quantity}</div>
                  </div>
                  <div><b>${Ui.money(i.lineTotal)}</b></div>
                </div>
              `).join("")}
            </div>
            <div style="display:flex; justify-content:flex-end; gap:18px; margin-top:10px">
              <div class="muted">Total: <b style="color:var(--text)">${Ui.money(o.total)}</b></div>
            </div>
          </div>
        `).join("");

        document.querySelectorAll("[data-savestatus]").forEach(b => {
          b.onclick = async () => {
            const id = parseInt(b.getAttribute("data-savestatus"));
            const sel = document.querySelector(`[data-status="${id}"]`);
            const status = sel.value;
            try { await Api.adminUpdateOrderStatus(id, status); Ui.toast("Updated", `Order #${id} status changed to ${status}.`); }
            catch (e) { Ui.toast("Error", e.message); }
          };
        });
      } catch (e) {
        el.innerHTML = `<div class="notice">${Ui.escapeHtml(e.message)}</div>`;
      }
    }

    (async () => {
      if (!ensureAdmin()) return;

      await fillCategorySelect();
      await loadCategories();
      await loadOrders();

      document.getElementById("addCat").onclick = async () => {
        const name = document.getElementById("catName").value.trim();
        try { await Api.adminCreateCategory({ id: 0, name }); document.getElementById("catName").value = ""; Ui.toast("Created", "Category added."); await loadCategories(); await fillCategorySelect(); }
        catch (e) { Ui.toast("Error", e.message); }
      };

      document.getElementById("createProduct").onclick = async () => {
        try { const res = await Api.adminCreateProduct(productPayload()); Ui.toast("Created", `Product #${res.id} added.`); }
        catch (e) { Ui.toast("Error", e.message); }
      };

      document.getElementById("loadProduct").onclick = async () => {
        const id = parseInt(document.getElementById("editId").value || "0");
        if (!id) return;
        try {
          const p = await Api.getProduct(id);
          document.getElementById("sku").value = p.sku;
          document.getElementById("pname").value = p.name;
          document.getElementById("brand").value = p.brand || "";
          document.getElementById("price").value = p.price;
          document.getElementById("stock").value = p.stock;
          document.getElementById("imageUrl").value = p.imageUrl || "";
          document.getElementById("desc").value = p.description || "";
          document.getElementById("catSelect").value = String(p.categoryId);
          document.getElementById("featured").value = p.isFeatured ? "true" : "false";
          Ui.toast("Loaded", `Product #${id} loaded.`);
        } catch (e) {
          Ui.toast("Error", e.message);
        }
      };

      document.getElementById("updateProduct").onclick = async () => {
        const id = parseInt(document.getElementById("editId").value || "0");
        if (!id) return;
        try { await Api.adminUpdateProduct(id, productPayload()); Ui.toast("Updated", `Product #${id} updated.`); }
        catch (e) { Ui.toast("Error", e.message); }
      };

      document.getElementById("deleteProduct").onclick = async () => {
        const id = parseInt(document.getElementById("editId").value || "0");
        if (!id) return;
        try { await Api.adminDeleteProduct(id); Ui.toast("Deleted", `Product #${id} deleted.`); }
        catch (e) { Ui.toast("Error", e.message); }
      };

      document.getElementById("refreshOrders").onclick = loadOrders;
    })();
  </script>
</body>
</html>
